<!DOCTYPE html>
<html lang="fa">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="stylesheet" href="../css/bootstarp.css" />
    <link rel="stylesheet" href="../css/style.css" />
  </head>
  <body style="direction: rtl" class="text-right rtl">
    <!-- navigation -->
    <nav class="navbar navbar-expand-md nabvar-light">
      <button
        class="navbar-toggler mb-2 bg-light"
        data-toggle="collapse"
        data-target="#mynav"
      >
        <span class="text-center">
          <i class="fa fa-navicon"></i>
        </span>
      </button>
      <div class="navbar-collapse collapse" id="mynav">
        <div class="container-fluid">
          <div class="row">
            <!-- sidbar -->
            <div class="col-xl-2 col-lg-3 col-md-4 sidebar fixed-top">
              <a
                href=""
                class="navbar-brand text-white d-block text-center mx-auto py-3 mb-4 bottom-border"
                >پنل ادمین</a
              >
              <div class="bottom-border pb-3">
                <img
                  src="./img/behnam.jpg"
                  class="rounded-circle ml-3"
                  style="width: 50px"
                  alt=""
                />
                <a href="" id="adminname" class="text-white">بهنام غفاری</a>
              </div>
              <ul class="nav-bar list-unstyled flex-column mt-4">
                <li class="nav-item  ">
                  <a href="./dashboard.html" class="nav-link text-white p3 mb-2  ">
                    <i class="fas fa-home fa-lg ml-3"></i> داشبورد
                  </a>
                </li>
                <li class="nav-item sidebar-link">
                  <a href="./alladmin.html" class="nav-link text-white p3 mb-2 ">
                    <i class="fas fa-user-secret  fa-lg ml-3"></i> ادمین ها
                  </a>
                </li>
                <li class="nav-item sidebar-link">
                  <a href="./usertable.html" class="nav-link text-white p3 mb-2 ">
                    <i class="fas fa-users fa-lg ml-3"></i> کاربران
                  </a>
                </li>
                <li class="nav-item sidebar-link ">
                  <a href="./allproductnew.html" class="nav-link text-white p3 mb-2  ">
                    <i class="fas fa-cubes fa-lg ml-3 "></i> محصولات
                  </a>
                </li>
                <li class="nav-item sidebar-link">
                  <a href="./orderbasket.html" class="nav-link text-white p3 mb-2  ">
                    <i class="fas fa-cart-plus   fa-lg ml-3"></i>سفارشات
                  </a>
                </li>
                <li class="nav-item sidebar-link current">
                  <a href="./orderbasket.html" class="nav-link text-white p3 mb-2  ">
                    <i class="fas fa-cart-plus   fa-lg ml-3"></i> سفارش جدید
                  </a>
                </li>
                <li class="nav-item sidebar-link">
                  <a href="./orderbasket.html" class="nav-link text-white p3 mb-2  ">
                    <i class="fas fa-cart-plus   fa-lg ml-3"></i>انبار
                  </a>
                </li>
                <li class="nav-item sidebar-link">
                  <a href="./allsend.html" class="nav-link text-white p3 mb-2  ">
                    <i class="fas fa-cart-arrow-down  fa-lg ml-3"></i> فروش
                  </a>
                </li>
                <li class="nav-item sidebar-link">
                  <a href="./pardakhti.html" class="nav-link text-white p3 mb-2  ">
                    <i class="fas fa-money-bill   fa-lg ml-3"></i> پرداختی
                  </a>
                </li>
                <li class="nav-item sidebar-link">
                  <a href="./allmessage.html" class="nav-link text-white p3 mb-2 ">
                    <i class="fas fa-commenting  fa-lg ml-3"></i> نظرات
                  </a>
                </li>
              </ul>
            </div>
            <!-- end sidbar -->
            <!-- topnav -->
            <div
              class="col-xl-10 col-lg-9 col-md-8 bg-dark mr-auto fixed-top py-2 top-navbar"
            >
              <div class="row">
                <div class="col-md-4">
                  <h4 class="text-light">داشبورد</h4>
                </div>
                <div class="col-md-5">
                  <form action="" class="my-4 my-md-0">
                    <div class="input-group">
                      <button class="btn btn-white search-button">
                        <i class="fas fa-search text-danger"></i>
                      </button>
                      <input
                        type="text"
                        name=""
                        id=""
                        class="form-control search-input"
                        placeholder="جستجو"
                      />
                    </div>
                  </form>
                </div>
                <div class="col-md-3">
                  <ul class="navbar-nav flex-row justify-content-between">
                    <li class="nav-item">
                      <a href="" class="nav-link">
                        <i class="fas fa-comments fa-lg text-muted"></i>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a
                        href="./orderbasket.html"
                        class="nav-link"
                        id="basketcount"
                        style="position: relative"
                      >
                        <i class="fas fa-shopping-basket fa-lg text-muted"></i>
                      </a>
                    </li>
                    <li class="nav-item">
                      <a href="" class="nav-link">
                        <i class="fas fa-bell fa-lg text-muted"></i>
                      </a>
                    </li>
                    <li class="nav-item mr-md-auto">
                      <a
                        href="#logoutModal"
                        data-toggle="modal"
                        class="nav-link"
                      >
                        <i class="fas fa-sign-out-alt fa-lg text-danger"></i>
                      </a>
                    </li>
                  </ul>
                </div>
              </div>
            </div>
            <!-- end topnav -->
          </div>
        </div>
      </div>
    </nav>
    <!-- end navigation -->

    <!-- modal -->
    <div class="modal fade" id="logoutModal">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4>آیا میخواهید خارج شوید؟</h4>
          </div>
          <div class="modal-body">
            <p class="text-muted">
              در صورت خروج برای دسترسی به پنل باید مجددا وارد شوید
            </p>
          </div>
          <div class="modal-footer">
            <button class="btn btn-success" data-dismiss="modal">میمانم</button>
            <button
              class="btn btn-danger"
              onclick="localStorage.removeItem('token');location.assign('./index.html')"
            >
              خارج میشوم
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- end modal -->

    <!-- other code -->
    <section>
      <div class="container-fluid">
        <div class="col-xl-10 col-lg-9 col-md-8 mr-auto">
          <div class="row pt-md-5 mt-md-2 mb-5">
            <h5
              class="col-10 mx-auto alert alert-info text-center"
              id="username2"
            >
            <div class="input-group row mx-auto">
              <input id="inputuser" class="form-control col-8" type="text" placeholder='جستجوی نام مشتری' >
              <input disabled id="factorNumber" class="form-control col-4"></input>
            </div>
            <div id="divuser"></div>
          </h5>
            <table
              class="table table-sm table-striped table-hover col-lg-10 col-sm-12 mx-auto text-center"
            >
              <thead>
                <tr class="row alert alert-success">
                  <th class="col-1">ردیف</th>
                  <th class="col-5">نام محصول</th>
                  <th class="col-1">تعداد</th>
                  <th class="col-2">فیمت</th>
                  <th class="col-3">جمع کل</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>

            <div
              id=""
              class="col-lg-10 col-sm-12 row mx-auto text-center input-group mt-5 m-0 p-0"
            >
              <input
                class="col-5 form-control"
                type="text"
                name=""
                disabled
                id="productname"
                placeholder="جستجوی نام محصول"
              />
              <input
                class="col-2 form-control"
                type="number"
                name=""
                id="productcount"
                disabled
                placeholder=" تعداد محصول"
              />
              <input
                class="col-2 form-control"
                type="number"
                name=""
                disabled
                id="productprice"
                placeholder=" قیمت محصول"
              />
              <input
                class="col-3 form-control"
                type="number"
                name=""
                disabled
                id="producttotalprice"
                placeholder=" قیمت نهایی محصول"
              />
            </div>
            <div id="productnamediv" class="col-lg-10 col-sm-12 row mx-auto text-center"></div>

            <div
              id="divadd"
              class="col-lg-10 col-sm-12 row mx-auto text-center"
            ></div>
            <button
              id="addorder"
              class="btn btn-info mt-2 col-lg-10 col-sm-12 mx-auto text-center"
              disabled
            >
              افزودن محصول به سفارش
            </button>

            <button
              id="endorder"
              class="btn btn-success col-lg-10 col-sm-12 mx-auto text-center mt-4"
              disabled
            >
              تایید نهایی سفارش
            </button>
          </div>
        </div>
      </div>
    </section>
    <!-- other code -->

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
<script src="alert.js"></script>

    <script>
      let factorNo ;
      let userId ;
      let user_telId ;
      let fullName ;
      const url = localStorage.url;
      const tbody = document.querySelector("#tbody");
      const endorder = document.querySelector("#endorder");
      const username2 = document.querySelector("#username2");
      const addorder = document.querySelector("#addorder");
      const productcount = document.querySelector("#productcount");
      const productprice = document.querySelector("#productprice");
      const producttotalprice = document.querySelector("#producttotalprice");
      const productname = document.querySelector("#productname");
      const divadd = document.querySelector("#divadd");
      const allp = []
      let products =[]
      let alldata;
      window.addEventListener('DOMContentLoaded',()=>{
       
        inputuser.focus()

    localStorage.products = localStorage.allproduct
      
    

    //  if(!localStorage.alluser){
    //   fetch(url + "/alluser", {
    //     headers: {
    //       Authorization: localStorage.getItem("token"),
    //     },
    //   })
    //     .then((res) => res.json())
    //     .then((d) => {
    //       console.log('d: ' ,d)
    //       localStorage.alluser = JSON.stringify(d.data);
    //       console.log('alluser', JSON.parse(localStorage.alluser))
    //     })
    //     .catch(err=>alpert(err.message))
    //  }
        })
    
      const factorNumber = document.querySelector('#factorNumber')
      const divuser = document.querySelector('#divuser')
      const inputuser = document.querySelector('#inputuser')
      factorNumber.value = 'شماره فاکتور :' + Date.now()

      if (!localStorage.token) location.assign("./index.html");

      const adminname = document.querySelector("#adminname");
      adminname.innerHTML = JSON.parse(localStorage.admininfo)["fullname"];

      fetch(url + "/unreadordercount" ,{
        headers : {
              "content-Type" : 'application/json',
              "Authorization": localStorage.getItem('token')
            }
      })
        .then((res) => res.json())
        .then((data) => {
          const basketcount = document.querySelector("#basketcount");
          basketcount.insertAdjacentHTML(
            "beforeend",
            `
  <span class="badge  badge-pill" style="position: absolute;top: 2px;right: 2px;">${data.data}</span>
  `
          );
        });
        let pprr ;
        productname.addEventListener('input',(e)=>{
        const productnamediv = document.querySelector('#productnamediv')
        let filterpr = []
        const regex = new RegExp(e.target.value.split('').join('.*') ,'i')
        allp.forEach(x=>{
      productnamediv.innerHTML = ''
      if(regex.test(x.name) && productname.value.length>0){
        filterpr.push({name:x.name ,price:x.price})    
      }
    })
      filterpr.forEach(y=>{
        productnamediv.insertAdjacentHTML('beforeend' , `
        <p class="alert alert-light" onclick="productname.value = this.innerHTML ; productname.disabled = true;productnamediv.innerHTML='';productcount.disabled=false ;productprice.disabled=false;productprice.value =${y.price} ;productcount.focus() ;pprr='${y}'">${y.name} </p>
        `)
      })
        })
     
      inputuser.addEventListener("input", (e) => {
        divuser.innerHTML = "";
        const alluser = JSON.parse(localStorage.alluser);
        console.log('alluser:  ',alluser)
        const filterduser = alluser.filter((x) =>
          x.fullName.includes(e.target.value) && e.target.value.length > 0
        );
      
        filterduser.forEach((x) => {
          divuser.insertAdjacentHTML(
            "beforeend",
            `
      <button onclick="inputuser.value = '${x.fullName}';inputuser.disabled = true  ;productname.removeAttribute('disabled') ;divuser.innerHTML = '';  productname.focus();localStorage.uname = this.innerHTML ; userId= ${x.id} ;user_telId= ${x.user_telId} " class="btn col-12 btn-info">${x.fullName}</button>
    `
          );
        });
        addorder.disabled == true
      });
      window.addEventListener('keyup',(e)=>{
        if(  productcount.value && productprice && inputuser.value ){
          addorder.disabled = false
        }else{
          addorder.disabled = true
        }
      })
      productcount.addEventListener("keyup", (e) => {
        if(e.keyCode==13){
          productprice.focus()
        }
        producttotalprice.value = productprice.value * productcount.value;
        // productcount.value && productprice && inputuser.value &&  (addorder.disabled = false) 
      });
      productname.addEventListener('input',()=>{
        productprice.disabled = true
        productcount.disabled = true
        productcount.value = ''
        productprice.value = ''
        producttotalprice.value = ''
      })
      productname.addEventListener('click' ,()=>{
        productname.removeAttribute('disabled')
        productprice.disabled = true
        productcount.disabled = true
        productname.value = ''
        productcount.value = ''
        productprice.value = ''
        producttotalprice.value = ''
      })
      productprice.addEventListener("keyup", (e) => {
        e.preventDefault()
        if(e.keyCode ==13){
          addorder.disabled = false
          addorder.click()
          productname.removeAttribute('disabled')
          productname.focus()
        }
      });

      productprice.addEventListener("keyup", () => {
        // productprice.value = +(productprice.value).toLocaleString('fa')
        producttotalprice.value = +(productprice.value).toLocaleString() * +(productcount.value).toLocaleString();
      });
      const ff  = []
      addorder.addEventListener("click", (e) => {
        productprice.disabled = true
        productcount.disabled = true
        addorder.disabled = true ;
        endorder.disabled = false
        e.preventDefault();
        e.stopPropagation()
        ff.push({
            name :productname.value, 
            count : +productcount.value,
            price : +productprice.value
          })
       if( productcount.value && productname.value && productprice.value ){
        const tdd = document.querySelectorAll(".tdd");
        tbody.insertAdjacentHTML(
          "beforeend",
          `
    <tr class="row">
                <td  class="col-1 tdd">${tdd.length + 1}</td>
                <td  contenteditable="true" class="col-5 productname1">${
                  productname.value
                }</td>
                <td  contenteditable="true" class="col-1 productcount1">${
                  productcount.value
                }</td>
                <td  contenteditable="true" class="col-2 productprice1">${
                  productprice.value
                }</td>
                <td  contenteditable="true" class="col-3">${
                  producttotalprice.value
                }</td>
               
              </tr>
    `
        );
        const inp = document.querySelectorAll("input");
        inp.forEach((x) => (x.value = ""));
       }
       inputuser.value = localStorage.uname
       productname.removeAttribute('disabled')
       productname.focus()
      });

      fetch(url + "/products", {
        headers: {
          Authorization: localStorage.getItem("token"),
        },
      })
        .then((res) => res.json())
        .then((data) => {
          console.log('data',data)
          // localStorage.products = JSON.stringify(data);
          data.forEach(x=>{
            if(x.type[0]){
              (x.type).forEach(y=>{
                allp.push({name:x.name + " " + y.type ,price:x.price})
              })
            }
          })
          console.log('allp :' , allp )
          localStorage.products = JSON.stringify(allp);

        });

   

       endorder.addEventListener('click' , ()=> {
         endorder.disabled = true ;
         addorder.disabled = true ;
         const productname = document.querySelectorAll(".productname1");
         const productcount = document.querySelectorAll(".productcount1");
         const productprice = document.querySelectorAll(".productprice1");
         const send = 
         {
           finalorderId : localStorage.infoorder1,//baraye tagheer status sefsresh be true
           fullName ,//baraye tagheer status sefsresh be true
           userId ,
           user_telId,
           orderfactorNo : factorNo ,
           // factor :[]
           factor :ff
          }
         
        fetch(`${url}/tordert`,{
          method : 'POST',
          headers : {
            'Content-Type' : 'application/json',
          Authorization: localStorage.getItem("token"),
          },
          body :JSON.stringify(send)
        })
        .then(res=>res.json())
        .then(d=>{
          const data = d.data
          console.log('data',data)
          alpert('فاکتور صادر شد')
          localStorage.infoorder1 = 0
          tbody.innerHTML = ''
          inputuser.value = ''
          location.assign('./orderbasket.html')
        })
        .catch(err=>{
         endorder.disabled = true ;
          console.log(err)
        })
      })

 document.querySelector('h4').innerHTML= document.querySelector('.current').innerHTML
 document.querySelector('h4').innerHTML= document.querySelector('.current').innerHTML
   if(JSON.parse(localStorage.admininfo).role !== 'manager'){
    document.querySelector('.fa-user-secret').parentNode.style.display = 'none'
   } 
    </script>
  </body>
</html>
